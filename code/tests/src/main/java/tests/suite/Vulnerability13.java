package tests.suite;

import net.sourceforge.jwebunit.api.IElement;
import net.sourceforge.jwebunit.junit.WebTester;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import tests.utilities.Helper;

/**
 * Proof of concept for the XSS vulnerability #13.
 * The vulnerable print involves the following line of the template:
 * <input type='hidden' name='semester' value='$_POST[semester]' />
 *
 * @author Davide Pedranz
 */
public final class Vulnerability13 {

    private WebTester tester;
    private Helper helper;

    @Before
    public void prepare() {
        tester = new WebTester();
        tester.setBaseUrl(Helper.BASE_URL);
        helper = new Helper(tester);
    }

    @Test
    public void test() {

        // login
        helper.loginAsAdmin();

        // move to the page to set a new assignment (vulnerable form)
        tester.clickLinkWithText("Attendance");
        tester.assertMatch("Attendance");

        // substitute the hidden form field with a tampered value (attack)
        final IElement field = tester.getElementByXPath("html//form[@name='registration']//select[@name='semester']//option");
        final String original = field.getAttribute("value");
        field.setAttribute("value", original + "' /> <script>alert('xss done')</script> <input type='hidden' name='xss' value='9999999");

        // submit the tampered form
        tester.clickButtonWithText("Add");
        tester.assertMatch("Add New Attendance Record");

        // xss
        tester.assertNoMatch("<script>alert('xss done')</script>");
    }

    @After
    public void cleanup() {
        // no-op, nothing to cleanup
    }
}
