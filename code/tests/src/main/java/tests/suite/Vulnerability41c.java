package tests.suite;

import com.gargoylesoftware.htmlunit.html.DomElement;
import net.sourceforge.jwebunit.api.IElement;
import net.sourceforge.jwebunit.htmlunit.HtmlUnitElementImpl;
import net.sourceforge.jwebunit.junit.WebTester;
import org.aeonbits.owner.ConfigFactory;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import tests.utilities.Environment;
import tests.utilities.Helper;

/**
 * Proof of concept for the XSS vulnerability #41.c.
 *
 * @author Davide Pedranz
 */
public final class Vulnerability41c {

    // dependencies
    private WebTester tester;
    private Helper helper;

    @Before
    public void prepare() {
        final Environment environment = ConfigFactory.create(Environment.class, System.getenv());
        tester = new WebTester();
        tester.setBaseUrl(environment.baseURL());
        helper = new Helper(environment, tester);
    }

    @Test
    public void test() {

        // this is a stored XSS vulnerability... login as admin
        helper.loginAsAdmin();

        // move to the page to edit the announcement
        tester.clickLinkWithText("Announcements");
        tester.assertMatch("Manage Announcements");

        // tamper the variable $delete[]
        tester.setWorkingForm("announcements");
        tester.checkCheckbox("delete[]");
        final IElement element = tester.getElementByXPath("//form[@name='announcements']//input[@name='delete[]']");
        final DomElement input = ((HtmlUnitElementImpl) element).getHtmlElement();
        input.setAttribute("value", "1 -- '> <script>alert('xss')</script> <span id='xss");
        tester.clickButtonWithText("Edit");

        // check if the XSS was successful
        tester.assertNoMatch("<script>alert('xss')</script>");
    }

    @After
    public void cleanup() {
        // no-op, nothing to cleanup
    }

}
