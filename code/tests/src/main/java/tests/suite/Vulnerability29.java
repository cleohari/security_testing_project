package tests.suite;

import net.sourceforge.jwebunit.junit.WebTester;
import org.aeonbits.owner.ConfigFactory;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import tests.utilities.Environment;
import tests.utilities.Helper;

import static org.junit.Assert.assertFalse;

/**
 * Proof of concept for the XSS vulnerability #29.
 * This is a stored XSS vulnerability, exploiting the absence of any sanitisation on the insert of a new semester.
 * NB: this vulnerability was NOT among the "min" files generated by Pixy.
 *
 * @author Davide Pedranz
 */
public final class Vulnerability29 {

    // dependencies
    private WebTester tester;
    private Helper helper;

    @Before
    public void prepare() {
        final Environment environment = ConfigFactory.create(Environment.class, System.getenv());
        tester = new WebTester();
        tester.setBaseUrl(environment.baseURL());
        helper = new Helper(environment, tester);
    }

    @Test
    public void test() {

        // attack
        helper.editTestSemester("<h1>XSS</h1>");

        // check if the XSS was successful, on the student home page
        helper.loginAsStudent();
        tester.assertMatch("name surname's Classes");
        assertFalse(tester.getPageSource().contains("<h1>XSS</h1>"));
    }

    @After
    public void cleanup() {
        helper.cleanupTestSemester();
    }
}
