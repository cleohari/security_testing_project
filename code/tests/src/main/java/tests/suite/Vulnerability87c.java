package tests.suite;

import net.sourceforge.jwebunit.api.IElement;
import net.sourceforge.jwebunit.junit.WebTester;
import org.aeonbits.owner.ConfigFactory;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import tests.utilities.Environment;
import tests.utilities.Helper;

import java.io.IOException;

/**
 * Proof of concept for the XSS vulnerability #87.c.
 *
 * @author Davide Pedranz
 */
public final class Vulnerability87c {

    // dependencies
    private WebTester tester;
    private Helper helper;

    @Before
    public void prepare() {
        final Environment environment = ConfigFactory.create(Environment.class, System.getenv());
        tester = new WebTester();
        tester.setBaseUrl(environment.baseURL());
        helper = new Helper(environment, tester);
    }

    @Test
    public void test() throws IOException {

        // the vulnerable page is accessible by a student
        helper.loginAsStudent();
        tester.assertMatch("name surname's Classes");

        // tamper the variable $_POST[selectclass]
        String xss = "1 -- \\'> <script>alert(\\'xss\\')</script> <span id=\\'xss";
        IElement elementByXPath = tester.getElementByXPath("//a[@href='JavaScript:document.classes.selectclass.value=1;document.classes.page2.value=1;document.classes.submit();']");
        elementByXPath.setAttribute("href", "JavaScript:document.classes.selectclass.value='" + xss + "';document.classes.page2.value=1;document.classes.submit();");
        tester.clickLinkWithText("course");

        // NB: for some reason, JWebUnit gets crazy on this page
        // and does not found forms and buttons correctly
        // the code above is a workaround

        // check if the XSS was successful
        tester.assertNoMatch("<script>alert('xss')</script>");
    }

    @After
    public void cleanup() {
        // no-op, nothing to cleanup
    }

}
